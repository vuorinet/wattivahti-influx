name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, servo]
    environment: production

    env:
      DEPLOY_PATH: /srv/wattivahti-influx

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run linting
        run: uv run ruff check .

      - name: Run type checking
        run: uv run ty check sync.py

      - name: Deploy application files
        run: |
          # Backup existing refresh token before deployment
          if [ -f ${{ env.DEPLOY_PATH }}/refresh_token.txt ]; then
            TMP_TOKEN=$(mktemp)
            cp ${{ env.DEPLOY_PATH }}/refresh_token.txt "$TMP_TOKEN"
            echo "Backed up refresh_token.txt"
          else
            TMP_TOKEN=""
            echo "No existing refresh_token.txt found"
          fi

          # Copy application files to target server
          rsync -aq --delete \
            --exclude='.git' \
            --exclude='.env' \
            --exclude='refresh_token.txt' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            ./ ${{ env.DEPLOY_PATH }}/

          # Restore refresh token if it existed
          if [ -n "$TMP_TOKEN" ] && [ -f "$TMP_TOKEN" ]; then
            cp "$TMP_TOKEN" ${{ env.DEPLOY_PATH }}/refresh_token.txt
            rm "$TMP_TOKEN"
            echo "Restored refresh_token.txt"
          fi

      - name: Create .env file
        run: |
          INITIAL_SYNC_DAYS="${{ vars.INITIAL_SYNC_DAYS }}"
          SYNC_BUFFER_HOURS="${{ vars.SYNC_BUFFER_HOURS }}"
          INITIAL_SYNC_DAYS=${INITIAL_SYNC_DAYS:-7}
          SYNC_BUFFER_HOURS=${SYNC_BUFFER_HOURS:-2}

          cat > ${{ env.DEPLOY_PATH }}/.env << EOF
          INFLUXDB_URL=${{ vars.INFLUXDB_URL }}
          INFLUXDB_TOKEN=${{ secrets.INFLUXDB_TOKEN }}
          INFLUXDB_ORG=${{ vars.INFLUXDB_ORG }}
          INFLUXDB_BUCKET=${{ vars.INFLUXDB_BUCKET }}
          WATTIVAHTI_METERING_POINT=${{ vars.WATTIVAHTI_METERING_POINT }}
          REFRESH_TOKEN_FILE=${{ env.DEPLOY_PATH }}/refresh_token.txt
          INITIAL_SYNC_DAYS=${INITIAL_SYNC_DAYS}
          SYNC_BUFFER_HOURS=${SYNC_BUFFER_HOURS}
          EOF

      - name: Set up cron job
        run: |
          DEPLOY_PATH="${{ env.DEPLOY_PATH }}"

          # Create wrapper script to avoid long cron line
          # Use Python from venv since cron doesn't have uv in PATH
          cat > "$DEPLOY_PATH/run_sync.sh" << 'WRAPPER_EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          .venv/bin/python sync.py >> sync.log 2>&1
          WRAPPER_EOF
          chmod +x "$DEPLOY_PATH/run_sync.sh"

          # Create short cron job entry
          CRON_ENTRY="0 * * * * $DEPLOY_PATH/run_sync.sh"

          # Check if cron job already exists
          if crontab -l 2>/dev/null | grep -q "run_sync.sh"; then
            # Update existing cron job
            crontab -l 2>/dev/null | sed "s|.*run_sync.sh.*|$CRON_ENTRY|" | crontab -
            echo "Updated existing cron job"
          else
            # Add new cron job
            (crontab -l 2>/dev/null; echo "$CRON_ENTRY") | crontab -
            echo "Added new cron job"
          fi

      - name: Verify deployment
        run: |
          echo "Deployment completed successfully"
          echo "Application path: ${{ env.DEPLOY_PATH }}"
          echo "Cron job status:"
          crontab -l | grep sync.py || echo "No cron job found"
